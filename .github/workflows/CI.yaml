name: CI
on:
  pull_request:
  push: { branches: main }

jobs:
  build:
    name: Build keeper-bot
    runs-on: ubuntu-latest

    steps:
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17.x

    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Build
      run: go build cmd/main.go 

  test:
    env:
      KEEPER_BOT_ENV: ${{ secrets.KEEPER_BOT_ENV }}
    name: Run Test Suite With Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17.x
  
    - name: Install Code Coverage
      uses: amancevice/setup-code-climate@v0
      with:
        cc_test_reporter_id: ${{ secrets.CC_TEST_REPORTER_ID }}
    
    - name: Checkout code
      uses: actions/checkout@v2

    - uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
  
    - name: Run solana-test-validator
      run: docker-compose --file ./build/githubactions/docker-compose.yaml up -d 

    - name: Code Coverage Before Build
      run: cc-test-reporter before-build

    - name: Run unit tests
      run: go test -coverprofile ./c.out $(go list ./...) || exit $?

    - name: Format Code Coverage File
      run: cc-test-reporter format-coverage -t gocov --prefix github.com/Dcaf-Protocol/keeper-bot c.out

    - name: Code Coverage After Build
      if: ${{ github.event_name != 'pull_request' }}
      run: cc-test-reporter after-build --prefix github.com/Dcaf-Protocol/keeper-bot --exit-code $?
    
    - name: Stop solana-test-validator
      run: docker-compose --file ./build/githubactions/docker-compose.yaml down 

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - uses: actions/checkout@v2
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          version: latest
          only-new-issues: true
          skip-go-installation: true
  
